"use strict";var express=require("express"),cors=require("cors"),mongoose=require("mongoose"),bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),User=require("./models/User.js"),Place=require("./models/Place.js"),Booking=require("./models/Booking.js"),cookieParser=require("cookie-parser"),Razorpay=require("razorpay"),shortid=require("shortid"),bodyParser=require("body-parser"),imageDownloader=require("image-downloader"),multer=require("multer"),fs=require("fs");require("dotenv").config();var app=express(),bcryptSalt=bcrypt.genSaltSync(10),jwtSecret="fasefraw4r5r3wq45wdfgw34twdfg",razorpay=new Razorpay({key_id:"rzp_test_4AAfE1spa0SuuG",key_secret:"LmVk3BAP6wDjj4Ls9Jw7onuU"});function getUserDataFromReq(r){return new Promise(function(n,e){jwt.verify(r.cookies.token,jwtSecret,{},function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)throw r;e.next=2;break;case 2:n(t);case 3:case"end":return e.stop()}})})})}app.use(express.json()),app.use(cookieParser()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use("/uploads",express.static(__dirname+"/uploads")),app.use(cors({credentials:!0,origin:"http://localhost:5173"})),mongoose.connect(process.env.MONGO_URL),app.get("/test",function(e,r){r.json("test ok")}),app.post("/register",function(r,t){var n,a,s,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,a=n.name,s=n.email,o=n.password,e.prev=1,e.next=4,regeneratorRuntime.awrap(User.create({name:a,email:s,password:bcrypt.hashSync(o,bcryptSalt)}));case 4:c=e.sent,t.json(c),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),t.status(422).json(e.t0);case 11:case"end":return e.stop()}},null,null,[[1,8]])}),app.post("/login",function(r,t){var n,a,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,a=n.email,s=n.password,e.next=3,regeneratorRuntime.awrap(User.findOne({email:a}));case 3:(o=e.sent)?bcrypt.compareSync(s,o.password)?jwt.sign({email:o.email,id:o._id},jwtSecret,{},function(e,r){if(e)throw e;t.cookie("token",r).json(o)}):t.status(422).json("pass not ok"):t.json("not found");case 5:case"end":return e.stop()}})}),app.get("/profile",function(e,c){var r=e.cookies.token;r?jwt.verify(r,jwtSecret,{},function(r,t){var n,a,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)throw r;e.next=2;break;case 2:return e.next=4,regeneratorRuntime.awrap(User.findById(t.id));case 4:n=e.sent,a=n.name,s=n.email,o=n._id,c.json({name:a,email:s,_id:o});case 9:case"end":return e.stop()}})}):c.json(null)}),app.post("/logout",function(e,r){r.cookie("token","").json(!0)}),console.log({__dirname:__dirname}),app.post("/upload-by-link",function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body.link,a="photo"+Date.now()+".jpg",e.next=4,regeneratorRuntime.awrap(imageDownloader.image({url:n,dest:__dirname+"/uploads/"+a}));case 4:t.json(a);case 5:case"end":return e.stop()}})});var photosMiddleware=multer({dest:"uploads"});app.post("/upload",photosMiddleware.array("photos",100),function(e,r){for(var t=[],n=0;n<e.files.length;n++){var a=e.files[n],s=a.path,o=a.originalname.split("."),c=s+"."+o[o.length-1];fs.renameSync(s,c),t.push(c.replace("uploads",""))}r.json(t)}),app.post("/places",function(e,a){var r=e.cookies.token,t=e.body,s=t.title,o=t.address,c=t.addedPhotos,i=t.description,p=t.price,u=t.extraInfo,d=t.date,l=t.time,f=t.maxParticipants;jwt.verify(r,jwtSecret,{},function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)throw r;e.next=2;break;case 2:return e.next=4,regeneratorRuntime.awrap(Place.create({owner:t.id,price:p,title:s,address:o,photos:c,description:i,extraInfo:u,date:d,time:l,maxParticipants:f}));case 4:n=e.sent,a.json(n);case 6:case"end":return e.stop()}})})}),app.get("/user-places",function(e,n){var r=e.cookies.token;jwt.verify(r,jwtSecret,{},function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.id,e.t0=n,e.next=4,regeneratorRuntime.awrap(Place.find({owner:t}));case 4:e.t1=e.sent,e.t0.json.call(e.t0,e.t1);case 6:case"end":return e.stop()}})})}),app.get("/places/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params.id,e.t0=t,e.next=4,regeneratorRuntime.awrap(Place.findById(n));case 4:e.t1=e.sent,e.t0.json.call(e.t0,e.t1);case 6:case"end":return e.stop()}})}),app.put("/places",function(r,a){var t,n,s,o,c,i,p,u,d,l,f,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.cookies.token,n=r.body,s=n.id,o=n.title,c=n.address,i=n.addedPhotos,p=n.description,u=n.extraInfo,d=n.date,l=n.time,f=n.maxParticipants,m=n.price,jwt.verify(t,jwtSecret,{},function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)throw r;e.next=2;break;case 2:return e.next=4,regeneratorRuntime.awrap(Place.findById(s));case 4:if(n=e.sent,t.id===n.owner.toString())return n.set({title:o,address:c,photos:i,description:p,extraInfo:u,date:d,time:l,maxParticipants:f,price:m}),e.next=9,regeneratorRuntime.awrap(n.save());e.next=10;break;case 9:a.json("ok");case 10:case"end":return e.stop()}})});case 3:case"end":return e.stop()}})}),app.delete("/places/:id",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params.id,e.prev=1,e.next=4,regeneratorRuntime.awrap(Place.findByIdAndDelete(n));case 4:t.json("event deleted successfully"),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),console.error("Error deleting place:",e.t0),t.status(500).send("Internal Server Error");case 11:case"end":return e.stop()}},null,null,[[1,7]])}),app.get("/places",function(e,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r,e.next=3,regeneratorRuntime.awrap(Place.find());case 3:e.t1=e.sent,e.t0.json.call(e.t0,e.t1);case 5:case"end":return e.stop()}})}),app.post("/bookings",function(m,w){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:try{r=m.cookies.token,jwt.verify(r,jwtSecret,function(r,t){var n,a,s,o,c,i,p,u,d,l,f;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)return e.abrupt("return",w.status(401).json({message:"Unauthorized"}));e.next=4;break;case 4:return n=t,a=m.body,s=a.place,o=a.numberOfParticipants,c=a.name,i=a.phone,p=a.price,u={amount:100*p,currency:"INR",receipt:shortid.generate(),payment_capture:1},e.prev=7,e.next=10,regeneratorRuntime.awrap(razorpay.orders.create(u));case 10:return d=e.sent,l=new Booking({place:s,user:n.id,numberOfParticipants:o,name:c,phone:i,price:p,razorpayOrderId:d.id}),e.next=14,regeneratorRuntime.awrap(l.save());case 14:f=e.sent,w.json(f),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(7),console.error("Error creating Razorpay order:",e.t0),w.status(500).send("Internal Server Error");case 22:case"end":return e.stop()}},null,null,[[7,18]])})}catch(e){console.log(e),w.status(500).send("Internal Server Error")}case 1:case"end":return e.stop()}})}),app.get("/bookings",function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(getUserDataFromReq(r));case 2:return n=e.sent,e.t0=t,e.next=6,regeneratorRuntime.awrap(Booking.find({user:n.id}).populate("place"));case 6:e.t1=e.sent,e.t0.json.call(e.t0,e.t1);case 8:case"end":return e.stop()}})}),app.listen(4e3);
//# sourceMappingURL=index.min.js.map
